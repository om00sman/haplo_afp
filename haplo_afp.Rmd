---
title: "haplo_afp"
output: html_document
date: "2024-11-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)
library(ggtree)
library(ape)
library(phytools)
library(readxl)
library(aplot)
library(cowplot)
library(fishtree)

```

```{r}
##fig4 hist

fig4 <- read("C:/Users/omoos/Downloads/zoarcoidei_haplo-afp (6).xlsx", sheet = "fig4graph")

#order species by their appearance in the data set rather than alphabetically

fig4$Species <- factor(fig4$Species, levels = unique(fig4$Species))

#graph

p <- ggplot(fig4, aes(x = Haplotype, fill = Type)) + 
  geom_bar(stat = "count") +
  geom_text(stat = "count", aes(label = ..count..), position = position_stack(vjust = 0.5)) +
  facet_wrap(~Species, ncol = 1) +
  theme(strip.text.x = element_blank(), panel.grid.major = element_blank(),    panel.grid.minor = element_blank()) +
  labs(y = "", x = "",) +
  scale_fill_manual(values = c("hap1v" = "#ED1C24", "hap2v" = "#00AEEF", "hap1m"="#F69D9F"))
  theme_minimal()
  
ggsave(plot = p, height = 5, width = 3, filename = "fig4plot.png" )

```


```{r}
#fig6 tree
hap_afp_tree <- fishtree_phylogeny(
  c("Lycodichthys dearborni", "Zoarces americanus", "Leptoclinus maculatus",
    "Pholis gunnellus", "Cebidichthys violaceus", "Anarhichas minor", "Anarhichas lupus"),
  type = c("chronogram"))

# Get the root age (total tree height)
tree_age <- max(ggtree(hap_afp_tree)$data$x)

# Format species names
hap_afp_tree$tip.label <- gsub("_", " ", hap_afp_tree$tip.label)
hap_afp_tree$tip.label <- paste0("italic('", hap_afp_tree$tip.label, "')")

# Plot tree to see if it looks accurate
tree_panel <- ggtree(hap_afp_tree) + 
  geom_tiplab(fontface = "italic", parse = TRUE, size = 5) + 
  theme_tree2() +
  geom_tree(size = 1) +
  labs(x = "Mya") +
  theme(
    axis.title.x = element_text(size = 20),
    axis.text.x = element_text(size = 15)) +
  scale_x_continuous(
    limits = c(-2, tree_age + 35),  # Extends left for labels, ends at 0
    breaks = tree_age - c(40, 30, 20, 10, 0),  
    labels = c(40, 30, 20, 10, 0),
    expand = c(0, 0)  # Ensures axis line ends at 0 without extra space
  )
tree_panel
```

```{r}
##fig6 dotplot

#import data

haplo_afp <- read.csv("~/Documents/GitHub/haplo_afp/zoarcoidei_haplo-afp - fig_6.csv")

#order species by their appearance in the data set rather than alphabetically

haplo_afp$species <- factor(haplo_afp$species, levels = unique(haplo_afp$species))

#change NA to "" in order to remove NA label in legend
haplo_afp$haplotype <- as.character(haplo_afp$haplotype)  # Convert to character
haplo_afp$haplotype[is.na(haplo_afp$haplotype)] <- ""  # Replace NA with empty string
haplo_afp$haplotype <- factor(haplo_afp$haplotype)  # Convert back to factor

# plot
dotplot <- ggplot(haplo_afp, aes(
                              x = median,
                              y = interaction(array, species), 
                              colour = haplotype)) +
  geom_point(position = position_dodge(width = 0.8), size = 3) +
  geom_errorbar(aes(
                xmin = min, xmax = max), 
                width = 0, 
                size = 1, 
                position = position_dodge(width = 0.8, preserve = "total")) +
  scale_x_continuous(breaks = seq(0, 130, by = 20)) +
  scale_y_discrete(limits = rev) +
  labs(y = "", x = "AFP copy number", color = "Haplotype") +
  scale_color_manual(values = c("hap1" = "#D71920", "hap2" = "#5BCBF5", "Unresolved" = "black")) +
  
  # Add group labels
  geom_text(aes(x = -20, label = array), hjust = 0.25, size = 5, color = "black") +

  # Use facets to separate species but remove labels
  facet_wrap(~ species, scales = "free_y", ncol = 1) +

  # adjust theme
  theme_classic(base_size = 20) +
  theme(strip.text = element_blank(),  # Remove facet labels
        panel.spacing = unit(0.5, "lines"),  # Increase spacing between species
        axis.text.y = element_blank(),  # Remove y-axis text
        axis.ticks.y = element_blank(),  # Remove y-axis ticks
        legend.position = "inside",
        legend.position.inside = c(0.8,0.8),
        plot.margin = margin(5, 10, 5, 0))

#combine plots

fig6 <- cowplot::plot_grid(tree_panel, dotplot, rel_widths = c(1,1.5))

fig6

ggsave(fig6,
       units = "in", width = 12, height = 6, 
       filename = "~/Documents/GitHub/haplo_afp/fig6.png",
       bg = "white")

##export size is 1400x900##
```