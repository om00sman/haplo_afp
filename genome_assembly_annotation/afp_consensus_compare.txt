##generate consensus sequence of species AFP##

#set paths

config_file=/hb/groups/kelley_training/owen/zoarcoidei/data/species.txt
name=$(sed -n "${SLURM_ARRAY_TASK_ID}p" "$config_file")
query=/hb/home/omoosman/owen/zoarcoidei/analysis/Mamericanus_AFP.txt
target=/hb/home/omoosman/owen/zoarcoidei/data/assemblies/$species/${species}_p_ctg.fasta
out=/hb/home/omoosman/owen/zoarcoidei/analysis/exonerate/$species

#load modules

module load miniconda3 mafft
conda activate exonerate

#output fasta of all exonerate hits for m_americanus query sequence

exonerate --model protein2genome --query $query \
  --target $target \
  --showtargetgff FALSE \
  --showquerygff FALSE \
  --showalignment FALSE \
  --showcigar FALSE \
  --showvulgar FALSE \
  --ryo ">%ti|(%tab - %tae)\n%tcs\n" \
  > "$out/${species}_seq.fasta"

#remove exonerate header and footer
sed '1,2d' "$out/${species}_seq.fasta" | sed '$d' > "$out/${species}_afpseq.fasta"

#generate multiple sequence alginment

mafft  --retree 2 --inputorder "$out/${species}_afpseq.fasta" "$out/${species}_mafft.fasta"

cons -sequence "$out/${species}_mafft.fasta" -outseq "$out/${species}_consensus.fasta" -plurality 1 -auto

##generate exonerate annotations for both consensus and z_americanus sequences ##

#load required modules

module load miniconda3
conda activate exonerate

#define variables

config_file=/hb/groups/kelley_training/owen/zoarcoidei/data/species.txt
name=$(sed -n "${SLURM_ARRAY_TASK_ID}p" "$config_file")
in=/hb/home/omoosman/owen/zoarcoidei/data/assemblies/$name
out=/hb/home/omoosman/owen/zoarcoidei/analysis/exonerate/$name

# Create the output directory 

mkdir -p "$out"

#exonerate query for with Mamericanus_AFP

exonerate --model protein2genome --query /hb/home/omoosman/owen/zoarcoidei/analysis/Mamericanus_AFP.txt --target "$in/${name}_hap1_ctg.fasta"  --showtargetgff TRUE --showquerygff FALSE > "$out/consensus_compare/${name}_hap1_Mamer_afp.gff"

exonerate --model protein2genome --query /hb/home/omoosman/owen/zoarcoidei/analysis/Mamericanus_AFP.txt --target "$in/${name}_hap2_ctg.fasta"  --showtargetgff TRUE --showquerygff FALSE > "$out/consensus_compare/${name}_hap2_Mamer_afp.gff"

#exonerate query for consensus AFP

exonerate --model protein2genome --query "$out/${name}_consensus_afp.fasta" --target "$in/${name}_hap1_ctg.fasta"  --showtargetgff TRUE --showquerygff FALSE > "$out/consensus_compare/${name}_hap1_consensus_afp.gff"

exonerate --model protein2genome --query "$out/${name}_consensus_afp.fasta" --target "$in/${name}_hap2_ctg.fasta"  --showtargetgff TRUE --showquerygff FALSE > "$out/consensus_compare/${name}_hap2_consensus_afp.gff"

#exonerate query for raw utg

exonerate --model protein2genome --query /hb/home/omoosman/owen/zoarcoidei/analysis/Mamericanus_AFP.txt --target "$in/${name}_r_utg.fasta"  --showtargetgff TRUE --showquerygff FALSE > "$out/consensus_compare/${name}_utg_Mamer_afp.gff"

exonerate --model protein2genome --query "$out/${name}_consensus_afp.fasta" --target "$in/${name}_r_utg.fasta"  --showtargetgff TRUE --showquerygff FALSE > "$out/consensus_compare/${name}_utg_consensus_afp.gff"

